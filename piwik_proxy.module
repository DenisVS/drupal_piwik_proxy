<?php

/**
 * Страница настроек в админке, и блок для вывода формы
 * @file
 * Module file for Piwik proxy module
 * @todo Облагородить код, написать комментарии.
 * $Id$
 */

/**
 * Implements hook_menu().
 */
function piwik_proxy_menu() {
  $items['admin/config/services/piwik_proxy'] = array(//Адрес страницы администрирования
    'title' => 'Piwik proxy', // Тайтл страницы
    'page callback' => 'drupal_get_form', //функция, отвечающая за вывод страницы
    'page arguments' => array('piwik_proxy_form'), // аргумент hook_form()
    'access arguments' => array('administer users'), // права доступа
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Implements hook_form().
 * Admin form to configurable piwik_proxy
 */
function piwik_proxy_form($form, &$form_state) {
  // Check library.
  $library = DRUPAL_ROOT . '/sites/all/libraries/piwik-tracker-proxy/piwik.php';
  if (!file_exists($library)) {
    drupal_set_message('Download ​<a href ="https://github.com/piwik/tracker-proxy/archive/master.zip">archive</a> or a <a href ="https://raw.githubusercontent.com/piwik/tracker-proxy/master/piwik.php">file directly</a>.');
    drupal_set_message('Place piwik.php into a new folder in the following location:<br />');
    drupal_set_message('sites/all/libraries/piwik-tracker-proxy<br />');
    drupal_set_message('So the actual library can be found at:<br />');
    drupal_set_message('sites/all/libraries/piwik-tracker-proxy/piwik.php<br />');
  }
  else {
    $form['piwikProxySiteID'] = array(
      '#type' => 'textfield',
      '#title' => t('Piwik site ID'),
      '#size' => 3,
      '#maxlength' => 3,
      '#required' => TRUE,
      '#default_value' => variable_get('piwikProxySiteID'), //дёргаем системную переменную
      '#description' => t("Go to Piwik &raquo; Settings &raquo; Websites &raquo; enter the appropriate site ID from the table of websites."),
    );

    $form['piwikUrl'] = array(
      '#type' => 'textfield',
      '#title' => t('Piwik URL'),
      '#size' => 50,
      '#maxlength' => 50,
      '#required' => TRUE,
      '#default_value' => variable_get('piwikUrl'),
      '#description' => t('Should contain the URL to your Piwik server, e.g, http://mysite.com/piwik/'),
    );

    $form['piwikProxyTokenAuth'] = array(
      '#type' => 'textfield',
      '#title' => t('Token auth'),
      '#size' => 50,
      '#maxlength' => 50,
      '#required' => TRUE,
      '#default_value' => variable_get('piwikProxyTokenAuth'),
      '#description' => t('In your Piwik server:<br />&#8226;login as Super user<br />&#8226;create a user, set the login for example: "UserTrackingAPI"<br />&#8226;assign this user admin permission on all websites you wish to track<br />&#8226;copy the <strong>token_auth</strong> for this user: you will use it later'),
    );
    $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Save settings'),
        //'#submit' => TRUE,
    );
  }
  return $form; //Важно! Отправлять всё, а не system_settings_form($form), 
}

/**
 * Функция сабмита формы. Выполняется вычисление и занесение переменных помимо формы.
 * Пишется конфигурационный файл.
 * @param array $form
 * @param array $form_state
 */
function piwik_proxy_form_submit($form, &$form_state) {
  variable_set('piwikProxySiteID', $form['piwikProxySiteID']['#value']);
  variable_set('piwikProxyTokenAuth', $form['piwikProxyTokenAuth']['#value']);
  variable_set('piwikUrl', $form['piwikUrl']['#value']);

  $file = DRUPAL_ROOT . '/sites/all/libraries/piwik-tracker-proxy/config.php';
  $targetFile = fopen($file, 'w') or drupal_set_message("can't open file");
  fwrite($targetFile, "<?php\n"); //выводим в файл
  fwrite($targetFile, "\$PIWIK_URL = '" . variable_get('piwikUrl') . "';\n"); //выводим в файл
  fwrite($targetFile, "\$TOKEN_AUTH = '" . variable_get('piwikProxyTokenAuth') . "';\n"); //выводим в файл
  fwrite($targetFile, '$timeout = 5' . ";\n"); //выводим в файл
  fclose($targetFile); //закрываем
  //Получаем из настроек переменные
  $siteID = variable_get('piwikProxySiteID');
  $proxyUrl = $GLOBALS['base_url'] . '/sites/all/libraries/piwik-tracker-proxy/';
  $proxyUrl = preg_replace('%(.*//)(.*)%', '$2', $proxyUrl);

  $htmlContent = "\n	" . 'var _paq = _paq || [];' . "\n";
  $htmlContent .= "  _paq.push(['trackPageView']);" . "\n";
  $htmlContent .= "  _paq.push(['enableLinkTracking']);" . "\n";
  $htmlContent .= '  (function() {' . "\n";
  $htmlContent .= '   var u="//' . $proxyUrl . '";' . "\n";
  $htmlContent .= "   _paq.push(['setTrackerUrl', u+'piwik.php']);" . "\n";
  $htmlContent .= "   _paq.push(['setSiteId', " . $siteID . ']);' . "\n";
  $htmlContent .= "   var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];" . "\n";
  $htmlContent .= "   g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.php'; s.parentNode.insertBefore(g,s);" . "\n";
  $htmlContent .= '  })();' . "\n";
  variable_set('piwikProxyCode', $htmlContent);
}

// Добавляем JS в footer
drupal_add_js(variable_get('piwikProxyCode'), array('type' => 'inline', 'scope' => 'footer', 'weight' => 0));
